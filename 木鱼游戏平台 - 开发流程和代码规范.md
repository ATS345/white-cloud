# 木鱼游戏平台 - 开发流程和代码规范

## 1. 概述

本文档定义了木鱼游戏平台的开发流程和代码规范，旨在确保团队开发的代码质量、可维护性和一致性。所有开发人员必须严格遵循本规范，确保项目的长期健康发展。

## 2. 开发流程

### 2.1 需求分析

1. **需求收集**：产品经理收集业务需求，编写需求文档
2. **需求评审**：开发团队、测试团队、产品经理共同评审需求
3. **技术方案设计**：架构师和开发负责人设计技术方案
4. **任务分解**：将需求分解为可执行的开发任务
5. **工作量评估**：评估每个任务的工作量和优先级

### 2.2 开发阶段

1. **分支管理**：
   - 主分支：`main`，用于生产环境部署
   - 开发分支：`develop`，用于集成所有功能
   - 特性分支：`feature/{feature-name}`，用于开发新功能
   - 修复分支：`fix/{issue-number}`，用于修复bug
   - 发布分支：`release/{version}`，用于准备发布

2. **代码开发**：
   - 从`develop`分支创建特性分支
   - 按照代码规范编写代码
   - 编写单元测试
   - 提交代码，使用语义化提交信息

3. **代码提交规范**：
   ```
   <type>(<scope>): <subject>
   
   <body>
   
   <footer>
   ```
   - **type**：
     - feat：新功能
     - fix：bug修复
     - docs：文档更新
     - style：代码风格修改
     - refactor：代码重构
     - test：测试代码
     - chore：构建过程或辅助工具的变动
   - **scope**：影响的模块或功能
   - **subject**：简短的描述
   - **body**：详细描述
   - **footer**：关联的issue或PR

4. **代码审查**：
   - 提交PR到`develop`分支
   - 至少2名开发人员进行代码审查
   - 审查内容：
     - 代码规范符合性
     - 功能正确性
     - 性能影响
     - 安全性
     - 可维护性
   - 审查通过后合并到`develop`分支

### 2.3 测试阶段

1. **单元测试**：
   - 测试框架：Jest
   - 测试覆盖率：≥80%
   - 执行时机：每次代码提交前

2. **集成测试**：
   - 测试框架：Supertest
   - 测试内容：服务间接口调用
   - 测试覆盖率：≥60%
   - 执行时机：每次合并到`develop`分支后

3. **系统测试**：
   - 测试框架：Postman/Newman
   - 测试内容：端到端功能测试
   - 测试覆盖率：≥40%
   - 执行时机：每次发布前

4. **性能测试**：
   - 测试工具：JMeter
   - 测试内容：并发测试、负载测试、压力测试
   - 执行时机：每次架构调整后

5. **安全测试**：
   - 测试工具：OWASP ZAP
   - 测试内容：漏洞扫描、渗透测试
   - 执行时机：每次发布前

### 2.4 部署阶段

1. **构建镜像**：
   - 使用Dockerfile构建容器镜像
   - 镜像标签：`{service-name}:{version}`
   - 推送镜像到镜像仓库

2. **环境部署**：
   - 开发环境：Docker Compose
   - 测试环境：Kubernetes集群
   - 生产环境：Kubernetes集群

3. **部署流程**：
   - CI/CD自动部署到开发环境
   - 手动触发部署到测试环境
   - 灰度发布到生产环境
   - 全量发布到生产环境

4. **监控与回滚**：
   - 监控服务状态和性能
   - 出现问题时立即回滚
   - 分析问题原因，修复后重新部署

## 3. 代码规范

### 3.1 基本规范

- **语言**：JavaScript (ES2021+)
- **模块系统**：ES模块 (import/export)
- **缩进**：4个空格
- **行宽**：120个字符
- **换行符**：LF
- **文件编码**：UTF-8

### 3.2 命名规范

#### 3.2.1 变量命名

- **驼峰命名法**：`camelCase`
  - 示例：`userName`, `gameList`, `paymentMethod`
- **常量命名**：`UPPER_CASE_WITH_UNDERSCORES`
  - 示例：`MAX_RETRY_COUNT`, `API_TIMEOUT`
- **避免单字符变量**：除了循环计数器和临时变量
  - 示例：`for (let i = 0; i < 10; i++) { ... }`

#### 3.2.2 函数命名

- **驼峰命名法**：`camelCase`
  - 示例：`getUserInfo()`, `createGame()`, `processPayment()`
- **动词开头**：清晰表达函数的行为
  - 示例：`get`, `set`, `create`, `update`, `delete`, `process`, `validate`
- **函数参数**：合理使用默认值，避免过多参数
  - 示例：`function getUserInfo(userId, options = {}) { ... }`

#### 3.2.3 类命名

- **帕斯卡命名法**：`PascalCase`
  - 示例：`User`, `Game`, `PaymentProcessor`
- **构造函数**：与类名相同
  - 示例：`class User { constructor() { ... } }`

#### 3.2.4 文件命名

- **驼峰命名法**：`camelCase`
  - 示例：`userController.js`, `gameService.js`, `authMiddleware.js`
- **模块文件**：使用单数形式
  - 示例：`user.js`而非`users.js`
- **索引文件**：`index.js`，用于导出模块

#### 3.2.5 目录命名

- **小写字母**：使用小写字母和连字符
  - 示例：`controllers`, `middleware`, `utils`
- **模块目录**：使用复数形式
  - 示例：`controllers`, `models`, `routes`

### 3.3 代码结构

#### 3.3.1 文件结构

```javascript
// 1. 导入依赖
import express from 'express';
import cors from 'cors';
import helmet from 'helmet';

// 2. 导入本地模块
import logger from './config/logger.js';
import redisClient from './config/redis.js';
import authRoutes from './routes/authRoutes.js';
import userRoutes from './routes/userRoutes.js';
import errorHandler from './middleware/errorHandler.js';

// 3. 初始化应用
const app = express();
const PORT = process.env.PORT || 3001;

// 4. 配置中间件
app.use(helmet());
app.use(cors());

// 5. 注册路由
app.use('/api/v1/auth', authRoutes);
app.use('/api/v1/users', userRoutes);

// 6. 错误处理
app.use(errorHandler);

// 7. 启动服务器
app.listen(PORT, () => {
  logger.info(`Server is running on port ${PORT}`);
});
```

#### 3.3.2 函数结构

```javascript
// 1. 函数声明
function getUserInfo(userId) {
  // 2. 参数验证
  if (!userId) {
    throw new Error('userId is required');
  }

  // 3. 业务逻辑
  try {
    // 4. 异步操作
    const user = await User.findById(userId);
    return user;
  } catch (error) {
    // 5. 错误处理
    logger.error(`Error getting user info: ${error.message}`);
    throw error;
  }
}
```

#### 3.3.3 类结构

```javascript
class User {
  // 1. 构造函数
  constructor(name, email) {
    this.name = name;
    this.email = email;
  }

  // 2. 实例方法
  getFullName() {
    return this.name;
  }

  // 3. 静态方法
  static async findById(id) {
    // 数据库查询逻辑
  }
}
```

### 3.4 ESLint配置

基于Airbnb规则集，以下是我们的ESLint配置：

```json
{
  "env": {
    "node": true,
    "es2021": true,
    "jest": true
  },
  "extends": [
    "eslint:recommended",
    "airbnb-base"
  ],
  "parserOptions": {
    "ecmaVersion": "latest",
    "sourceType": "module"
  },
  "plugins": [
    "import"
  ],
  "rules": {
    "no-unused-vars": "error",
    "no-console": "warn",
    "indent": ["error", 4],
    "quotes": ["error", "single"],
    "semi": ["error", "always"],
    "comma-dangle": ["error", "always-multiline"],
    "import/extensions": [
      "error",
      "ignorePackages",
      {
        "js": "always"
      }
    ],
    "import/no-extraneous-dependencies": ["error", { "devDependencies": true }]
  },
  "settings": {
    "import/resolver": {
      "node": {
        "extensions": [".js"]
      }
    }
  }
}
```

### 3.5 代码审查要点

1. **代码规范符合性**：
   - 缩进、命名规范、代码结构
   - ESLint无错误

2. **功能正确性**：
   - 实现了预期功能
   - 边界情况处理
   - 错误处理

3. **性能影响**：
   - 避免不必要的计算
   - 合理使用缓存
   - 数据库查询优化

4. **安全性**：
   - 输入验证
   - 防止SQL注入
   - 防止XSS攻击
   - 敏感数据保护

5. **可维护性**：
   - 代码可读性
   - 函数职责单一
   - 模块化设计
   - 适当的注释

6. **测试覆盖率**：
   - 单元测试覆盖核心功能
   - 测试用例设计合理

## 4. 质量标准

### 4.1 代码质量

- **ESLint错误**：0
- **ESLint警告**：≤10
- **代码重复率**：≤5%
- **函数复杂度**：
  - 圈复杂度：≤10
  - 函数长度：≤50行
  - 参数数量：≤5

### 4.2 测试覆盖率

- **单元测试覆盖率**：≥80%
- **集成测试覆盖率**：≥60%
- **系统测试覆盖率**：≥40%
- **关键功能覆盖率**：100%

### 4.3 性能要求

- **响应时间**：
  - P95：< 500ms
  - P99：< 1000ms
- **吞吐量**：
  - QPS：≥ 1000
  - 并发连接数：≥ 10000

### 4.4 可用性要求

- **服务可用性**：≥ 99.9%
- **数据可用性**：≥ 99.99%
- **故障恢复时间**：≤ 5分钟

## 5. 最佳实践

### 5.1 设计模式

1. **MVC模式**：
   - Model：数据模型
   - View：API响应
   - Controller：业务逻辑

2. **中间件模式**：
   - 认证中间件
   - 错误处理中间件
   - 日志中间件

3. **单例模式**：
   - 数据库连接
   - Redis连接
   - 日志实例

4. **工厂模式**：
   - 服务工厂
   - 控制器工厂

5. **装饰器模式**：
   - 缓存装饰器
   - 日志装饰器

### 5.2 安全措施

1. **认证与授权**：
   - JWT认证
   - 基于角色的访问控制
   - API密钥管理

2. **输入验证**：
   - 请求参数验证
   - 数据类型验证
   - 业务规则验证

3. **数据保护**：
   - 敏感数据加密
   - 密码哈希存储
   - 传输加密（HTTPS）

4. **防止攻击**：
   - SQL注入防护
   - XSS防护
   - CSRF防护
   - 限流熔断

### 5.3 性能优化

1. **缓存策略**：
   - Redis缓存
   - 本地缓存
   - 缓存预热
   - 缓存失效策略

2. **数据库优化**：
   - 索引优化
   - 查询优化
   - 读写分离
   - 分库分表

3. **代码优化**：
   - 异步编程
   - 减少不必要的计算
   - 合理使用数据结构

4. **服务优化**：
   - 服务拆分
   - 负载均衡
   - 自动扩缩容

### 5.4 日志与监控

1. **日志规范**：
   - 日志级别：DEBUG, INFO, WARN, ERROR
   - 日志格式：JSON格式
   - 日志内容：请求ID, 时间戳, 级别, 消息, 上下文

2. **监控指标**：
   - 响应时间
   - 错误率
   - 吞吐量
   - 资源使用率

3. **告警规则**：
   - 错误率超过阈值
   - 响应时间过长
   - 服务不可用
   - 资源使用率过高

## 6. 开发工具

### 6.1 开发环境

- **Node.js**：18.x
- **npm**：8.x
- **Docker**：20.x
- **Kubernetes**：1.24.x

### 6.2 代码编辑

- **VS Code**：推荐编辑器
  - 插件：ESLint, Prettier, GitLens, Docker
- **WebStorm**：可选编辑器

### 6.3 版本控制

- **Git**：版本控制工具
- **GitLab**：代码托管平台
  - CI/CD集成
  - 代码审查
  - Issue管理

### 6.4 测试工具

- **Jest**：单元测试框架
- **Supertest**：API测试框架
- **Postman**：API测试工具
- **JMeter**：性能测试工具
- **OWASP ZAP**：安全测试工具

### 6.5 监控工具

- **Prometheus**：监控系统
- **Grafana**：可视化工具
- **ELK Stack**：日志收集和分析
- **Alertmanager**：告警管理

## 7. 文档规范

### 7.1 API文档

- **工具**：Swagger/OpenAPI 3.0
- **格式**：YAML或JSON
- **内容**：
  - 服务基本信息
  - API端点
  - 请求参数
  - 响应格式
  - 认证授权
  - 错误码

### 7.2 技术文档

- **架构文档**：系统架构、模块划分、技术选型
- **设计文档**：详细设计、数据库设计、API设计
- **部署文档**：部署流程、环境配置、监控方案
- **运维文档**：日常运维、故障处理、备份恢复

### 7.3 代码注释

- **模块注释**：文件顶部，描述模块功能
- **函数注释**：函数顶部，描述函数功能、参数、返回值
- **代码注释**：复杂逻辑、边界情况、特殊处理
- **注释格式**：使用JSDoc

```javascript
/**
 * 用户认证控制器
 * 处理用户注册、登录、登出等功能
 */

/**
 * 用户注册
 * @param {Object} req - 请求对象
 * @param {Object} req.body - 请求体
 * @param {string} req.body.username - 用户名
 * @param {string} req.body.email - 邮箱
 * @param {string} req.body.password - 密码
 * @param {Object} res - 响应对象
 * @returns {Promise<void>}
 */
async function register(req, res) {
  // 实现注册逻辑
}
```

## 8. 变更管理

### 8.1 变更流程

1. **变更申请**：提交变更申请，包括变更内容、影响范围、风险评估
2. **变更评审**：架构师和相关团队评审变更申请
3. **变更实施**：按照评审意见实施变更
4. **变更测试**：进行充分测试，确保变更正确
5. **变更发布**：灰度发布或全量发布
6. **变更监控**：监控变更后的系统状态
7. **变更记录**：记录变更内容、时间、负责人

### 8.2 版本管理

- **版本号格式**：`v{major}.{minor}.{patch}`
  - **major**：不兼容的API变更
  - **minor**：向后兼容的功能新增
  - **patch**：向后兼容的问题修复

- **版本发布流程**：
  1. 创建发布分支
  2. 测试发布分支
  3. 合并到`main`分支
  4. 打版本标签
  5. 部署到生产环境
  6. 合并回`develop`分支

## 9. 团队协作

### 9.1 沟通机制

- **每日站会**：15分钟，同步进展和问题
- **周会**：总结上周工作，规划下周任务
- **技术分享**：定期分享技术知识和最佳实践
- **即时通讯**：使用企业微信或Slack进行日常沟通
- **Issue管理**：使用GitLab Issues跟踪任务和问题

### 9.2 协作规范

- **代码共享**：所有代码提交到Git仓库
- **文档共享**：使用企业内部文档系统
- **知识共享**：定期更新技术文档和最佳实践
- **问题反馈**：及时反馈问题，共同解决

## 10. 附录

### 10.1 术语定义

| 术语 | 定义 |
|------|------|
| MVC | 模型-视图-控制器 |
| JWT | JSON Web Token |
| RBAC | 基于角色的访问控制 |
| QPS | 每秒查询数 |
| P95 | 95%的请求响应时间不超过该值 |
| P99 | 99%的请求响应时间不超过该值 |
| CI/CD | 持续集成/持续部署 |

### 10.2 参考文档

- [Airbnb JavaScript Style Guide](https://github.com/airbnb/javascript)
- [ESLint Documentation](https://eslint.org/docs/user-guide/)
- [Jest Documentation](https://jestjs.io/docs/getting-started)
- [Swagger Documentation](https://swagger.io/docs/)
- [Docker Documentation](https://docs.docker.com/)
- [Kubernetes Documentation](https://kubernetes.io/docs/home/)

### 10.3 联系方式

- **架构师**：xxx
- **开发负责人**：xxx
- **测试负责人**：xxx
- **产品经理**：xxx
- **技术支持**：xxx@example.com

## 11. 文档修订记录

| 版本 | 修订日期 | 修订内容 | 修订人 |
|------|----------|----------|--------|
| 1.0 | 2024-01-01 | 初始版本 | 架构团队 |
| 1.1 | 2024-01-15 | 更新代码规范 | 开发团队 |
| 1.2 | 2024-02-01 | 添加质量标准 | 测试团队 |
