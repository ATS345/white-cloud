# 木鱼游戏平台 - 微服务接口标准文档

## 1. 概述

本文档定义了木鱼游戏平台微服务架构的接口标准，包括每个微服务的模块边界、API端点、请求响应格式、认证授权机制和错误处理规范。所有微服务必须遵循本标准，确保服务间通信的一致性和可靠性。

## 2. 微服务模块边界划分

### 2.1 模块边界定义

| 服务名称 | 核心模型 | 主要功能 | 依赖服务 |
|---------|---------|---------|---------|
| user-service | User | 用户认证、用户管理、角色管理 | - |
| game-service | Game, GameCategory, GameTag, GameVersion, GameSystemRequirement | 游戏管理、游戏列表、游戏详情、游戏分类、游戏标签 | - |
| cart-service | Cart, CartItem | 购物车管理、购物车商品管理 | user-service, game-service |
| payment-service | Order, OrderItem | 订单管理、支付处理、支付回调 | user-service, game-service, cart-service |
| download-service | GameLibrary | 游戏下载、安装管理、版本更新 | user-service, game-service, payment-service |
| review-service | Review, ReviewReply, ReviewMedia | 游戏评价、评论管理、评分统计 | user-service, game-service |
| developer-service | Developer, DeveloperFinance, WithdrawalRequest | 开发者管理、游戏发布、财务报表、提现管理 | user-service, game-service, payment-service |
| recommendation-service | Recommendation | 游戏推荐、个性化推荐、热门游戏推荐 | user-service, game-service, review-service, download-service |
| gateway-service | - | API网关、服务发现、负载均衡、认证授权 | 所有服务 |

### 2.2 数据边界划分

| 服务名称 | 数据库 | 数据职责 |
|---------|---------|---------|
| user-service | users-db | 用户数据、角色数据 |
| game-service | games-db | 游戏数据、分类数据、标签数据、版本数据 |
| cart-service | cart-db | 购物车数据、购物车商品数据 |
| payment-service | payments-db | 订单数据、订单商品数据、支付数据 |
| download-service | downloads-db | 游戏库数据、下载记录、安装记录 |
| review-service | reviews-db | 评价数据、评论回复数据、评价媒体数据 |
| developer-service | developers-db | 开发者数据、财务数据、提现请求数据 |
| recommendation-service | recommendations-db | 推荐数据、用户行为数据 |

## 3. API设计标准

### 3.1 基本规范

- **API版本控制**：使用URI路径版本控制，格式为 `/api/v{version}/`
- **HTTP方法**：严格遵循RESTful设计原则
  - GET：获取资源
  - POST：创建资源
  - PUT：更新资源（全量）
  - PATCH：更新资源（部分）
  - DELETE：删除资源
- **资源命名**：使用复数形式，如 `/api/v1/users`
- **参数传递**：
  - 路径参数：用于唯一标识资源，如 `/api/v1/users/{id}`
  - 查询参数：用于过滤、排序、分页，如 `/api/v1/users?page=1&limit=10`
  - 请求体：用于创建或更新资源，使用JSON格式

### 3.2 统一响应格式

所有API响应必须使用统一的JSON格式，包括成功和失败响应。

#### 3.2.1 成功响应

```json
{
  "success": true,
  "data": {},
  "message": "操作成功",
  "timestamp": "2024-01-01T00:00:00.000Z",
  "requestId": "uuid"
}
```

#### 3.2.2 失败响应

```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "错误信息",
    "details": {
      "field": "错误字段",
      "reason": "错误原因"
    }
  },
  "timestamp": "2024-01-01T00:00:00.000Z",
  "requestId": "uuid"
}
```

### 3.3 错误码标准

| 错误码 | 含义 | HTTP状态码 |
|-------|------|------------|
| INVALID_REQUEST | 无效请求 | 400 |
| UNAUTHORIZED | 未授权 | 401 |
| FORBIDDEN | 禁止访问 | 403 |
| NOT_FOUND | 资源不存在 | 404 |
| CONFLICT | 资源冲突 | 409 |
| INTERNAL_SERVER_ERROR | 内部服务器错误 | 500 |
| SERVICE_UNAVAILABLE | 服务不可用 | 503 |
| GATEWAY_TIMEOUT | 网关超时 | 504 |

### 3.4 认证与授权

#### 3.4.1 认证机制

- **JWT令牌**：所有需要认证的API必须在请求头中携带JWT令牌
  ```
  Authorization: Bearer {token}
  ```
- **API密钥**：服务间通信使用API密钥
  ```
  X-API-Key: {api-key}
  ```

#### 3.4.2 授权机制

- **基于角色的访问控制（RBAC）**：
  - USER：普通用户
  - DEVELOPER：开发者
  - ADMIN：管理员
- **权限粒度**：API端点级别

## 4. 各微服务接口定义

### 4.1 user-service接口

#### 4.1.1 认证接口

| 端点 | 方法 | 功能 | 认证 | 角色 |
|------|------|------|------|------|
| /api/v1/auth/register | POST | 用户注册 | 否 | 无 |
| /api/v1/auth/login | POST | 用户登录 | 否 | 无 |
| /api/v1/auth/logout | POST | 用户登出 | 是 | 所有 |
| /api/v1/auth/refresh | POST | 刷新令牌 | 是 | 所有 |
| /api/v1/auth/me | GET | 获取当前用户信息 | 是 | 所有 |

#### 4.1.2 用户管理接口

| 端点 | 方法 | 功能 | 认证 | 角色 |
|------|------|------|------|------|
| /api/v1/users | GET | 获取用户列表 | 是 | ADMIN |
| /api/v1/users/{id} | GET | 获取用户详情 | 是 | ADMIN |
| /api/v1/users/{id} | PUT | 更新用户信息 | 是 | ADMIN |
| /api/v1/users/{id} | DELETE | 删除用户 | 是 | ADMIN |
| /api/v1/users/{id}/role | PATCH | 更新用户角色 | 是 | ADMIN |

### 4.2 game-service接口

#### 4.2.1 游戏列表接口

| 端点 | 方法 | 功能 | 认证 | 角色 |
|------|------|------|------|------|
| /api/v1/games | GET | 获取游戏列表 | 否 | 无 |
| /api/v1/games/{id} | GET | 获取游戏详情 | 否 | 无 |
| /api/v1/games/categories | GET | 获取游戏分类 | 否 | 无 |
| /api/v1/games/tags | GET | 获取游戏标签 | 否 | 无 |
| /api/v1/games/{id}/versions | GET | 获取游戏版本列表 | 否 | 无 |
| /api/v1/games/{id}/requirements | GET | 获取游戏系统需求 | 否 | 无 |

#### 4.2.2 游戏管理接口

| 端点 | 方法 | 功能 | 认证 | 角色 |
|------|------|------|------|------|
| /api/v1/games | POST | 创建游戏 | 是 | DEVELOPER |
| /api/v1/games/{id} | PUT | 更新游戏信息 | 是 | DEVELOPER |
| /api/v1/games/{id} | DELETE | 删除游戏 | 是 | DEVELOPER |
| /api/v1/games/{id}/versions | POST | 发布游戏版本 | 是 | DEVELOPER |
| /api/v1/games/{id}/requirements | POST | 添加游戏系统需求 | 是 | DEVELOPER |

### 4.3 cart-service接口

#### 4.3.1 购物车管理接口

| 端点 | 方法 | 功能 | 认证 | 角色 |
|------|------|------|------|------|
| /api/v1/cart | GET | 获取购物车 | 是 | USER |
| /api/v1/cart/items | POST | 添加商品到购物车 | 是 | USER |
| /api/v1/cart/items/{itemId} | PUT | 更新购物车商品数量 | 是 | USER |
| /api/v1/cart/items/{itemId} | DELETE | 删除购物车商品 | 是 | USER |
| /api/v1/cart/clear | POST | 清空购物车 | 是 | USER |

### 4.4 payment-service接口

#### 4.4.1 订单管理接口

| 端点 | 方法 | 功能 | 认证 | 角色 |
|------|------|------|------|------|
| /api/v1/orders | GET | 获取订单列表 | 是 | USER |
| /api/v1/orders/{id} | GET | 获取订单详情 | 是 | USER |
| /api/v1/orders | POST | 创建订单 | 是 | USER |
| /api/v1/orders/{id}/cancel | POST | 取消订单 | 是 | USER |

#### 4.4.2 支付接口

| 端点 | 方法 | 功能 | 认证 | 角色 |
|------|------|------|------|------|
| /api/v1/payments | POST | 发起支付 | 是 | USER |
| /api/v1/payments/{id} | GET | 查询支付状态 | 是 | USER |
| /api/v1/payments/callback | POST | 支付回调 | 否 | 无 |

### 4.5 download-service接口

#### 4.5.1 游戏库接口

| 端点 | 方法 | 功能 | 认证 | 角色 |
|------|------|------|------|------|
| /api/v1/library | GET | 获取游戏库 | 是 | USER |
| /api/v1/library/{id} | GET | 获取游戏库详情 | 是 | USER |
| /api/v1/library/{id}/install | POST | 安装游戏 | 是 | USER |
| /api/v1/library/{id}/update | POST | 更新游戏 | 是 | USER |
| /api/v1/library/{id}/uninstall | POST | 卸载游戏 | 是 | USER |
| /api/v1/library/{id}/launch | POST | 启动游戏 | 是 | USER |

### 4.6 review-service接口

#### 4.6.1 评价管理接口

| 端点 | 方法 | 功能 | 认证 | 角色 |
|------|------|------|------|------|
| /api/v1/reviews | GET | 获取评价列表 | 否 | 无 |
| /api/v1/reviews/{id} | GET | 获取评价详情 | 否 | 无 |
| /api/v1/reviews | POST | 创建评价 | 是 | USER |
| /api/v1/reviews/{id} | PUT | 更新评价 | 是 | USER |
| /api/v1/reviews/{id} | DELETE | 删除评价 | 是 | USER |

#### 4.6.2 评论回复接口

| 端点 | 方法 | 功能 | 认证 | 角色 |
|------|------|------|------|------|
| /api/v1/reviews/{id}/replies | GET | 获取评价回复 | 否 | 无 |
| /api/v1/reviews/{id}/replies | POST | 创建评价回复 | 是 | USER |
| /api/v1/reviews/{id}/replies/{replyId} | PUT | 更新评价回复 | 是 | USER |
| /api/v1/reviews/{id}/replies/{replyId} | DELETE | 删除评价回复 | 是 | USER |

### 4.7 developer-service接口

#### 4.7.1 开发者管理接口

| 端点 | 方法 | 功能 | 认证 | 角色 |
|------|------|------|------|------|
| /api/v1/developer | GET | 获取开发者信息 | 是 | DEVELOPER |
| /api/v1/developer | PUT | 更新开发者信息 | 是 | DEVELOPER |

#### 4.7.2 财务接口

| 端点 | 方法 | 功能 | 认证 | 角色 |
|------|------|------|------|------|
| /api/v1/developer/finances | GET | 获取财务报表 | 是 | DEVELOPER |
| /api/v1/developer/withdrawals | GET | 获取提现记录 | 是 | DEVELOPER |
| /api/v1/developer/withdrawals | POST | 提交提现请求 | 是 | DEVELOPER |

### 4.8 recommendation-service接口

#### 4.8.1 推荐接口

| 端点 | 方法 | 功能 | 认证 | 角色 |
|------|------|------|------|------|
| /api/v1/recommendations/personalized | GET | 获取个性化推荐 | 是 | USER |
| /api/v1/recommendations/popular | GET | 获取热门游戏推荐 | 否 | 无 |
| /api/v1/recommendations/new | GET | 获取新游戏推荐 | 否 | 无 |
| /api/v1/recommendations/similar/{gameId} | GET | 获取相似游戏推荐 | 否 | 无 |

## 5. 请求与响应示例

### 5.1 用户注册请求

**请求URL**：`/api/v1/auth/register`
**请求方法**：POST
**请求体**：
```json
{
  "username": "testuser",
  "email": "test@example.com",
  "password": "Password123!",
  "role": "user"
}
```

**成功响应**：
```json
{
  "success": true,
  "data": {
    "id": 1,
    "username": "testuser",
    "email": "test@example.com",
    "role": "user",
    "createdAt": "2024-01-01T00:00:00.000Z"
  },
  "message": "用户注册成功",
  "timestamp": "2024-01-01T00:00:00.000Z",
  "requestId": "uuid"
}
```

**失败响应**：
```json
{
  "success": false,
  "error": {
    "code": "INVALID_REQUEST",
    "message": "无效的请求参数",
    "details": {
      "password": "密码必须包含至少8个字符，包括大小写字母和数字"
    }
  },
  "timestamp": "2024-01-01T00:00:00.000Z",
  "requestId": "uuid"
}
```

### 5.2 获取游戏列表请求

**请求URL**：`/api/v1/games?page=1&limit=10&category=action`
**请求方法**：GET
**请求头**：`Authorization: Bearer {token}`

**成功响应**：
```json
{
  "success": true,
  "data": {
    "games": [
      {
        "id": 1,
        "title": "游戏名称",
        "price": 99.99,
        "discountPrice": 79.99,
        "rating": 4.5,
        "reviewCount": 100,
        "mainImageUrl": "https://example.com/image.jpg"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 100,
      "totalPages": 10
    }
  },
  "message": "获取游戏列表成功",
  "timestamp": "2024-01-01T00:00:00.000Z",
  "requestId": "uuid"
}
```

## 6. 接口文档标准

### 6.1 文档生成

- **工具**：使用Swagger/OpenAPI 3.0
- **格式**：YAML或JSON
- **位置**：每个微服务的根目录下的`swagger.js`文件

### 6.2 文档内容

- **服务基本信息**：名称、版本、描述
- **API端点**：所有API端点的详细信息
- **请求参数**：路径参数、查询参数、请求体
- **响应格式**：成功响应和失败响应的示例
- **认证授权**：认证方式和权限要求
- **错误码**：所有可能的错误码和描述

### 6.3 文档访问

- **本地访问**：`http://{service-host}:{service-port}/api/v1/docs`
- **网关访问**：`http://{gateway-host}:{gateway-port}/{service-name}/api/v1/docs`

## 7. 错误处理机制

### 7.1 错误类型

- **客户端错误**：4xx状态码
  - 无效请求参数
  - 未授权访问
  - 资源不存在
  - 资源冲突

- **服务器错误**：5xx状态码
  - 内部服务器错误
  - 服务不可用
  - 网关超时

### 7.2 错误日志

- **日志级别**：ERROR
- **日志内容**：
  - 请求ID
  - 错误码
  - 错误信息
  - 错误堆栈
  - 请求参数
  - 响应内容
  - 时间戳

### 7.3 错误监控

- **监控指标**：错误率、错误类型分布、错误趋势
- **告警规则**：
  - 错误率超过阈值（如5%）
  - 特定错误码频繁出现
  - 服务不可用

## 8. 性能要求

### 8.1 响应时间

- **P95响应时间**：< 500ms
- **P99响应时间**：< 1000ms
- **超时时间**：5000ms

### 8.2 吞吐量

- **QPS**：≥ 1000
- **并发连接数**：≥ 10000

### 8.3 可用性

- **服务可用性**：≥ 99.9%
- **数据可用性**：≥ 99.99%

## 9. 安全要求

### 9.1 数据加密

- **传输加密**：所有外部通信使用HTTPS
- **存储加密**：敏感数据（如密码）加密存储
- **API密钥加密**：API密钥使用哈希算法存储

### 9.2 输入验证

- **请求参数验证**：所有请求参数必须进行验证
- **数据类型验证**：验证数据类型和格式
- **业务规则验证**：验证业务逻辑规则
- **防注入攻击**：使用参数化查询，防止SQL注入

### 9.3 访问控制

- **最小权限原则**：每个服务只能访问其所需的资源
- **IP白名单**：服务间通信使用IP白名单
- **API密钥管理**：定期轮换API密钥

## 10. 变更管理

### 10.1 接口变更流程

1. **变更申请**：提交接口变更申请
2. **变更评审**：由架构师和相关团队评审
3. **变更实施**：修改接口代码和文档
4. **变更测试**：进行单元测试和集成测试
5. **变更发布**：灰度发布或全量发布
6. **变更监控**：监控变更后的服务状态

### 10.2 接口版本管理

- **版本号格式**：v{major}.{minor}.{patch}
- **主版本变更**：不兼容的API变更
- **次版本变更**：向后兼容的功能新增
- **补丁版本变更**：向后兼容的问题修复

## 11. 附录

### 11.1 术语定义

| 术语 | 定义 |
|------|------|
| API | 应用程序编程接口 |
| JWT | JSON Web Token |
| RBAC | 基于角色的访问控制 |
| QPS | 每秒查询数 |
| P95 | 95%的请求响应时间不超过该值 |
| P99 | 99%的请求响应时间不超过该值 |

### 11.2 联系方式

- **架构师**：xxx
- **API管理员**：xxx
- **技术支持**：xxx@example.com

## 12. 文档修订记录

| 版本 | 修订日期 | 修订内容 | 修订人 |
|------|----------|----------|--------|
| 1.0 | 2024-01-01 | 初始版本 | 架构团队 |
| 1.1 | 2024-01-15 | 添加推荐服务接口 | 架构团队 |
| 1.2 | 2024-02-01 | 更新错误处理机制 | 架构团队 |
